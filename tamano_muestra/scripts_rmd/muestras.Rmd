---
title: "Funciones muestreo"
output: html_document
---

En este documento explicamos como usar las funciones `select_sample_prop` y 
`select_sample_str` del paquete `quickcount` para simular el proceso del día de 
la elección y las casillas faltantes.

```{r, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(
    comment = "#>",
    collapse = TRUE
)
```

```{r}
library(quickcount) # devtools::install_github("tereom/quickcount")
library(tidyverse)
```

Usaremos los datos de cómputos distritales 2012 descargable en el [portal del INE](http://portalanterior.ine.mx/archivos3/portal/historico/contenido/Procesos_Electorales_Acervo_Electronico/). La descripción de los datos se encuentra en el archivo [dd_COMPUTOS2012.html](datos/datos_computos_2012_09072012_2015/dd_COMPUTOS2012.hmtl)

```{r}
computos_p <- read_delim("../pruebas_2012/datos/datos_computos_2012_09072012_2015/datos_computos_casillas_presidente.txt", "|", escape_double = FALSE, trim_ws = TRUE)

computos_casilla <- computos_p %>%
    dplyr::mutate(
        id_casilla = str_c(ID_ESTADO, ID_CASILLA, D_DISTRITO, SECCION, 
            TIPO_CASILLA, EXT_CONTIGUA, sep = "-"),
        estado = ID_ESTADO,
        distrito = str_c(ID_ESTADO, D_DISTRITO, sep = "-"),
        seccion = SECCION, 
        casilla = CASILLA, 
        lista_nominal = LISTA_NOMINAL,
        pan = PAN, 
        pri = PRI + PVEM + PRI_PVEM, 
        prd = PRD + PT + MC + PRD_PT + PRD_MC + PRD_PT_MC, 
        otros = PANAL + NUM_VOTOS_NULOS + NUM_VOTOS_CAN_NREG, 
        total = pan + pri + prd + otros
        ) %>% 
    select(id_casilla:total) # %>% 
    # gather(partido, n_votos, pan:otros)
```

Muestra con probabilidad proporcional al tamaño del estrato, muestreamos 
el 5% de las casillas.

```{r}
muestra_prop <- select_sample_prop(computos_casilla, stratum = distrito, 0.05)
```

Para muestreo aleatorio simple se omite la variable stratum.

```{r}
muestra_mas <- select_sample_prop(computos_casilla, frac = 0.05)
```

Si el tamaño de muestra varía por estrato se requiere el parámetro `allocation`
donde se indica para cada estrato el número de individuos o la proporción a 
muestrear en cada estrato.

```{r}
asignacion <-  computos_casilla %>% 
  count(distrito) %>% 
  mutate(
    p_muestra = sample(c(0.04, 0.05, 0.08), size = n_distinct(computos_casilla$distrito), 
      replace = TRUE),
    n_muestra = round(n * p_muestra)
  )

glimpse(asignacion)

# usando tamaño de muestra
muestra_est <- select_sample_str(computos_casilla, asignacion, n_muestra, distrito)
# usando proporción debemos especificar con is_frac = TRUE
muestra_est <- select_sample_str(computos_casilla, asignacion, p_muestra, distrito, 
  is_frac = TRUE)
glimpse(muestra_est)
```

Para simular faltantes se pueden usar las mismas funciones, supongamos que 
en la última muestra queremos simular que faltaron 10% de las casillas de tipo
urbano y 30% de las casillas de tipo rural.

```{r}
faltantes <- data_frame(casilla = c(1, 2), p_final = c(0.9, 0.7))
  
muestra_faltantes <- select_sample_str(muestra_prop, faltantes, p_final, casilla, 
  is_frac = TRUE)
glimpse(muestra_faltantes)
```

Y podemos simular de manera similar para escenarios más complejos o con base
en la llegada de remesas de 2012:

```{r}
library(lubridate)
remesas_2012 <- readxl::read_excel("../pruebas_2012/datos/Muestras de conteos rápidos 2012_2017/ConRemesaFinal/Base_Conteo_Presidencial 2012_final.xlsx")

llegada_remesas <- remesas_2012 %>% 
  mutate(
    estado = base_pres_id_ESTADO, 
    distrito = str_c(estado, base_pres_ID_DISTRITO, sep = "-"), 
    remesas,
    casilla = CASILLA, 
    hora_transmision = strftime(hora_transmision, format="%H:%M:%S"),
    dia_hora = FECHA_HORA
  ) %>% 
  mutate(
    antes_10 = dia_hora < ymd_hms("2012-07-01 22:00:00 UTC"), 
    antes_9 = dia_hora < ymd_hms("2012-07-01 21:00:00 UTC"),
    antes_8 = dia_hora < ymd_hms("2012-07-01 20:00:00 UTC"),
    antes_7 = dia_hora < ymd_hms("2012-07-01 19:00:00 UTC")
    )
```

Por tipo de casillas las remesas llegaron

```{r}
llegada_remesas %>% 
  filter(!is.na(casilla)) %>% 
  group_by(casilla) %>% 
  summarise_at(vars(antes_10:antes_7), mean, na.rm = TRUE)
```

Por estado

```{r}
llegada_estado <- llegada_remesas %>% 
  filter(!is.na(estado)) %>% 
  group_by(estado) %>% 
  summarise_at(vars(antes_10:antes_7), mean, na.rm = TRUE)
llegada_estado
```

Entonces si quisiéramos simular los faltantes por estado hasta las 9 pm haríamos:

```{r}
muestra_faltantes <- select_sample_str(muestra_prop, llegada_estado, antes_9, 
  estado, is_frac = TRUE)

glimpse(muestra_faltantes)
```





